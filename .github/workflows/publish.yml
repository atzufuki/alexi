name: Publish to JSR

on:
  push:
    tags:
      - "v*" # Trigger on version tags like v0.6.3

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write # Required for JSR publishing

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Verify formatting
        run: deno fmt --check

      - name: Run linter
        run: deno lint

      - name: Run unit tests
        run: deno task test:unit

      - name: Install Playwright browsers
        run: deno run -A npm:playwright install chromium

      - name: Run E2E tests
        run: deno task test:e2e

      - name: Find workspace packages
        id: find-packages
        run: |
          # Get workspace members from deno.json
          WORKSPACES=$(jq -r '.workspace[]' deno.json)
          echo "Found workspace packages:"
          echo "$WORKSPACES"
          echo "$WORKSPACES" > /tmp/packages.txt

      - name: Publish packages
        run: |
          echo "## ðŸš€ Publishing to JSR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SUCCESS_COUNT=0
          FAIL_COUNT=0

          # Publish each workspace package
          while IFS= read -r PKG_DIR; do
            # Get package name from deno.jsonc
            PKG_PATH="$PKG_DIR/deno.jsonc"
            if [ ! -f "$PKG_PATH" ]; then
              PKG_PATH="$PKG_DIR/deno.json"
            fi

            PKG_NAME=$(jq -r '.name' "$PKG_PATH")

            echo "Publishing $PKG_NAME from $PKG_DIR..."

            # Capture output and exit code
            set +e
            OUTPUT=$(cd "$PKG_DIR" && deno publish --allow-dirty --allow-slow-types --no-check 2>&1)
            EXIT_CODE=$?
            set -e

            echo "$OUTPUT"

            if [ $EXIT_CODE -eq 0 ]; then
              echo "- âœ… $PKG_NAME" >> $GITHUB_STEP_SUMMARY
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "- âŒ $PKG_NAME (exit code: $EXIT_CODE)" >> $GITHUB_STEP_SUMMARY
              echo "  Error: $OUTPUT" >> $GITHUB_STEP_SUMMARY
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
          done < /tmp/packages.txt

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** $SUCCESS_COUNT succeeded, $FAIL_COUNT failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View on JSR](https://jsr.io/@alexi)" >> $GITHUB_STEP_SUMMARY

          if [ $FAIL_COUNT -gt 0 ]; then
            exit 1
          fi
